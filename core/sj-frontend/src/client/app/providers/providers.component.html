<sj-spinner [isRunning]="showSpinner"></sj-spinner>

<div class="row">
  <!-- Content -->
  <div class="col col-xs-8">
    <div class="card">
      <div class="card-block">
        <!-- Card title -->
        <div class="row">
          <div class="col col-xs-4"><h4 class="card-title">Providers list</h4></div>
          <div class="col col-xs-8">
            <button type="button"
                    class="btn btn-primary pull-right ml-1 mb-1"
                    (click)="CreateProvider.show()"><i class="fa fa-plus mr-1"></i>Create Provider
            </button>

            <sj-search-box class="pull-right"
                           (update)="nameterm = $event"></sj-search-box>

            <sj-filter class="pull-right" [filterList]="providerTypes"
                           (update)="typeterm = $event"></sj-filter>

          </div>
        </div>

        <!-- Alerts -->
        <sj-alerts [alerts]="alerts"></sj-alerts>

        <!-- Providers list -->
        <div class="table-wrapper">
          <table class="table table-hover table-sm mt-1 mb-0">
            <thead>
              <tr>
                <th>Name</th>
                <th>Description</th>
                <th class="actions-column">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="!providerList || (providerList && providerList.length === 0)">
                <td colspan="20" class="text-center">No providers have been found.</td>
              </tr>

              <tr *ngFor="let provider of providerList | orderBy: 'name' | listFilter : {name : nameterm, type: typeterm} "
                  [ngClass]="{ 'table-info': provider === currentProvider }"
                  (click)="selectProvider(provider)">
                <td>{{ provider.name }}</td>
                <td>{{ provider.description }}</td>
                <td class="actions-column">
                  <button type="button"
                          class="btn btn-sm btn-secondary"
                          title="Delete provider"
                          (click)="deleteProviderConfirm(DeleteProvider, provider)">
                    <i class="fa fa-trash"></i>
                  </button>
                  <button type="button"
                          class="btn btn-sm btn-secondary"
                          title="Test connection"
                          (click)="testConnection(provider)">
                    <i class="fa fa-refresh"
                       [ngClass]="{ 'fa-spin': currentConnectors.indexOf(provider.name) >= 0 }"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Detailed info -->
  <div class="col col-xs-4">
    <div class="card">
      <div class="card-header">Detailed information about node</div>
      <div class="card-block">
        <div class="overflow-x-scroll">
          <ul *ngIf="currentProvider">
            <li>Name: {{currentProvider.name}}</li>
            <li>Type: {{currentProvider.type}}</li>
            <li>Description: {{currentProvider.description}}</li>
            <li>Hosts:
              <ul>
                <li *ngFor="let host of currentProvider.hosts">{{host}}</li>
              </ul>
            </li>
            <li *ngIf="currentProvider.login">Login: {{currentProvider.login}}</li>
            <li *ngIf="currentProvider.password">Password: {{currentProvider.password}}</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<div bsModal #CreateProvider="bs-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <button type="button" class="close" aria-label="Close" (click)="CreateProvider.hide()">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title">Create Provider</h4>
        <sj-alerts [alerts]="formAlerts"></sj-alerts>
      </div>

      <div class="modal-body">
        <form #providerForm="ngForm"
              (ngSubmit)="createProvider(CreateProvider)">

          <!-- Type -->
          <fieldset class="form-group row">
            <label class="col-form-label col-sm-2 required">Choose type</label>
            <div class="col-sm-10">
              <select class="form-control"
                      [(ngModel)]="newProvider.type"
                      name="providerType"
                      required>
                <option *ngFor="let type of providerTypes" value="{{type}}"
                        [disabled]="type ==='aerospike' || type === 'cassandra'">{{type}}</option>
              </select>
            </div>
          </fieldset>

          <!-- Name -->
          <fieldset class="form-group row">
            <label class="col-form-label col-sm-2 required">Name</label>
            <div class="col-sm-10">
              <input required [(ngModel)]="newProvider.name" name="providerName" type="text"
                     class="form-control" pattern="[a-zA-z][a-zA-Z0-9-]*" placeholder="Enter provider name">
            </div>
          </fieldset>

          <!-- Description -->
          <fieldset class="form-group row">
            <label class="col-form-label col-sm-2">Description</label>
            <div class="col-sm-10">
              <textarea [(ngModel)]="newProvider.description" name="providerDescription"
                        class="form-control" placeholder="Enter provider description"></textarea>
            </div>
          </fieldset>


          <!-- Hosts -->
          <fieldset class="form-group row">
            <label class="col-sm-2 col-form-label required">Hosts</label>
            <div class="col-sm-10">
              <div *ngFor="let host of newProvider.hosts; let i = index; trackBy:customTrackBy"
                   class="input-group mb-1">
                <input required
                       pattern="\d+(.\d+){3}:\d+"
                       [(ngModel)]="newProvider.hosts[i]"  name="providerHosts{{i}}"
                       type="text" class="form-control " placeholder="IPv4:port">
                <span class="input-group-btn" *ngIf="i!==0">
                  <button type="button"
                          class="btn btn-secondary"
                          (click)="deleteHost(i)">
                    <i class="fa fa-remove"></i>
                  </button>
                </span>
              </div>
              <button type="button" (click)="addHost()" class="btn btn-sm btn-secondary">+ Add Host</button>
            </div>
          </fieldset>

          <!-- Login -->
          <fieldset class="form-group row">
            <label class="col-sm-2 col-form-label">Login</label>
            <div class="col-sm-10">
              <input [(ngModel)]="newProvider.login" name="providerLogin" type="text" class="form-control"
                     placeholder="Enter provider login">
            </div>
          </fieldset>

          <!-- Password -->
          <fieldset class="form-group row">
            <label class="col-sm-2 col-form-label">Password</label>
            <div class="col-sm-10">
              <input [(ngModel)]="newProvider.password" name="providerPassword" type="text"
                     class="form-control" placeholder="Enter provider password">
            </div>
          </fieldset>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="CreateProvider.hide()">Cancel</button>
        <button [disabled]="!providerForm.form.valid" type="submit" class="btn btn-primary"
                (click)="createProvider(CreateProvider)">Create
        </button>
      </div>
    </div>
  </div>
</div>


<div bsModal #DeleteProvider="bs-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" aria-label="Close" (click)="DeleteProvider.hide()">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title">Delete confirmation</h4>
      </div>

      <div class="modal-body" *ngIf="currentProvider && (blockingServices.length === 0)">
        <p>Do you really want to delete provider "{{ currentProvider.name }}" ? This action can not be undone!</p>
      </div>

      <div class="modal-body" *ngIf="currentProvider && (blockingServices.length > 0)">
        <p>Unable to delete provider! Next services using provider "{{ currentProvider.name }}"</p>
        <ul>
          <li *ngFor="let service of blockingServices">{{service}}</li>
        </ul>
      </div>

      <div class="modal-footer">
        <template [ngIf]="currentProvider && (blockingServices.length === 0)">
          <button type="button" class="btn btn-secondary" (click)="DeleteProvider.hide()">Cancel</button>
          <button type="button" class="btn btn-danger"
                  (click)="deleteProvider(DeleteProvider)">Delete
          </button>
        </template>

        <template [ngIf]="currentProvider && (blockingServices.length > 0)">
          <button type="button" class="btn btn-primary" (click)="DeleteProvider.hide()">OK</button>
        </template>
      </div>
    </div>
  </div>
</div>
